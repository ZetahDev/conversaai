---
import DashboardLayout from '@/layouts/DashboardLayout.astro';

// Verificar autenticación
const token = Astro.cookies.get('access_token');
if (!token) {
  return Astro.redirect('/login');
}

// Obtener datos del usuario
let user: any = null;
let company: any = null;

try {
  // Obtener información del usuario
  const userResponse = await fetch('http://localhost:8000/api/v1/auth/me', {
    headers: {
      'Authorization': `Bearer ${token.value}`,
      'Content-Type': 'application/json',
    },
  });

  if (userResponse.ok) {
    user = await userResponse.json();
  } else {
    Astro.cookies.delete('access_token');
    return Astro.redirect('/login');
  }

  // Obtener información de la empresa
  const companyResponse = await fetch('http://localhost:8000/api/v1/companies/me', {
    headers: {
      'Authorization': `Bearer ${token.value}`,
      'Content-Type': 'application/json',
    },
  });

  if (companyResponse.ok) {
    company = await companyResponse.json();
  }

} catch (error) {
  console.error('Error obteniendo datos:', error);
}

// Manejar logout
if (Astro.request.method === 'POST' && Astro.url.searchParams.get('action') === 'logout') {
  Astro.cookies.delete('access_token');
  return Astro.redirect('/login');
}
---

<DashboardLayout title="Configuración - ChatBot SAAS" user={user} company={company}>
  <!-- Header -->
  <div class="px-4 py-6 sm:px-0">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
      Configuración
    </h1>
    <p class="mt-2 text-gray-600 dark:text-gray-400">
      Gestiona tu cuenta, empresa y preferencias del sistema.
    </p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Sidebar de navegación -->
    <div class="lg:col-span-1">
      <nav class="space-y-1">
        <a href="#perfil" class="bg-blue-50 dark:bg-blue-900 border-blue-500 text-blue-700 dark:text-blue-200 hover:bg-blue-50 dark:hover:bg-blue-900 hover:text-blue-700 dark:hover:text-blue-200 group border-l-4 px-3 py-2 flex items-center text-sm font-medium">
          <svg class="text-blue-500 mr-3 h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
          Perfil Personal
        </a>
        <a href="#empresa" class="border-transparent text-gray-900 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-gray-300 group border-l-4 px-3 py-2 flex items-center text-sm font-medium">
          <svg class="text-gray-400 group-hover:text-gray-500 mr-3 h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
          Información de Empresa
        </a>
        <a href="#seguridad" class="border-transparent text-gray-900 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-gray-300 group border-l-4 px-3 py-2 flex items-center text-sm font-medium">
          <svg class="text-gray-400 group-hover:text-gray-500 mr-3 h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          Seguridad
        </a>
        <a href="#notificaciones" class="border-transparent text-gray-900 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-gray-900 dark:hover:text-gray-300 group border-l-4 px-3 py-2 flex items-center text-sm font-medium">
          <svg class="text-gray-400 group-hover:text-gray-500 mr-3 h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM4 19h6v-2H4v2zM4 15h8v-2H4v2zM4 11h10V9H4v2z" />
          </svg>
          Notificaciones
        </a>
      </nav>
    </div>

    <!-- Contenido principal -->
    <div class="lg:col-span-2">
      <!-- Perfil Personal -->
      <div id="perfil" class="bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
            Perfil Personal
          </h3>
          <div class="mt-2 max-w-xl text-sm text-gray-500 dark:text-gray-400">
            <p>Actualiza tu información personal y preferencias de cuenta.</p>
          </div>
          <form class="mt-5 space-y-4">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
              <div>
                <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                  Email
                </label>
                <input
                  type="email"
                  name="email"
                  id="email"
                  value={user?.email || ''}
                  class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm"
                />
              </div>
              <div>
                <label for="role" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                  Rol
                </label>
                <input
                  type="text"
                  name="role"
                  id="role"
                  value={user?.role || ''}
                  disabled
                  class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-50 dark:bg-gray-600 text-gray-500 dark:text-gray-400 sm:text-sm"
                />
              </div>
            </div>
            <div>
              <button
                type="submit"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium"
              >
                Guardar cambios
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Información de Empresa -->
      <div id="empresa" class="bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
            Información de Empresa
          </h3>
          <div class="mt-2 max-w-xl text-sm text-gray-500 dark:text-gray-400">
            <p>Gestiona la información de tu empresa.</p>
          </div>
          <form class="mt-5 space-y-4">
            <div>
              <label for="company_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Nombre de la empresa
              </label>
              <input
                type="text"
                name="company_name"
                id="company_name"
                value={company?.name || ''}
                class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm"
              />
            </div>
            <div>
              <label for="industry" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Industria
              </label>
              <select
                name="industry"
                id="industry"
                class="mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white sm:text-sm"
              >
                <option>Tecnología</option>
                <option>Retail</option>
                <option>Servicios</option>
                <option>Manufactura</option>
                <option>Salud</option>
                <option>Educación</option>
                <option>Otro</option>
              </select>
            </div>
            <div>
              <button
                type="submit"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium"
              >
                Actualizar empresa
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Seguridad -->
      <div id="seguridad" class="bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
            Seguridad
          </h3>
          <div class="mt-2 max-w-xl text-sm text-gray-500 dark:text-gray-400">
            <p>Gestiona la seguridad de tu cuenta.</p>
          </div>
          <div class="mt-5 space-y-4">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="text-sm font-medium text-gray-900 dark:text-white">Cambiar contraseña</h4>
                <p class="text-sm text-gray-500 dark:text-gray-400">Actualiza tu contraseña regularmente</p>
              </div>
              <button class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-md text-sm font-medium">
                Cambiar
              </button>
            </div>
            <div class="flex items-center justify-between">
              <div>
                <h4 class="text-sm font-medium text-gray-900 dark:text-white">Autenticación de dos factores</h4>
                <p class="text-sm text-gray-500 dark:text-gray-400">Añade una capa extra de seguridad</p>
              </div>
              <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                Activar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>
